# 用户管理模块文档

## 1. 模块概述

本系统支持两种角色：**管理员(Superuser)** 和 **普通用户(User)**。管理员具有创建和管理所有用户的权限，普通用户只能管理自己的账户信息。

## 2. 角色权限

### 2.1 管理员权限
- 创建新用户账号
- 查看所有用户列表
- 编辑任意用户信息
- 删除用户（除自己外）
- 重置用户密码
- 启用/禁用用户账号

### 2.2 普通用户权限
- 查看自己的账户信息
- 修改自己的基本信息（姓名、邮箱）
- 修改自己的密码
- 删除自己的账号（非管理员）

## 3. 后端功能设计

### 3.1 数据模型

基于现有的 `models.py`，用户相关的数据模型包括：

```python
# 用户基础信息
class UserBase(SQLModel):
    email: EmailStr = Field(unique=True, index=True, max_length=255)
    is_active: bool = True
    is_superuser: bool = False
    full_name: str | None = Field(default=None, max_length=255)

# 数据库模型
class User(UserBase, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    hashed_password: str
    items: list["Item"] = Relationship(back_populates="owner", cascade_delete=True)
```

### 3.2 CRUD 操作

现有的 `crud.py` 提供了基础的用户操作：

- `create_user()` - 创建用户
- `update_user()` - 更新用户信息
- `get_user_by_email()` - 根据邮箱获取用户
- `authenticate()` - 用户认证

### 3.3 权限控制

基于现有的 `deps.py` 权限依赖：

- `get_current_active_superuser` - 管理员权限检查
- `CurrentUser` - 当前登录用户
- `SessionDep` - 数据库会话依赖

## 4. API 接口设计

根据 api.mdc 规范，所有 API 遵循以下格式：

### 4.1 通用 API 响应格式

```json
{
  "error": 0,
  "body": {},
  "message": ""
}
```

- `error = 0`: 成功
- `error = 401`: 需要登录
- `error = 403`: 权限不足
- `error = 500`: 系统异常
- 其他值: 业务异常

### 4.2 用户管理相关 API

#### 4.2.1 管理员专用接口

**1. 获取用户列表**
```
POST /api/v1/users/list
Header: auth: <token>
Body: {
  "skip": 0,
  "limit": 100
}

Response:
{
  "error": 0,
  "body": {
    "data": [
      {
        "id": "uuid",
        "email": "user@example.com",
        "full_name": "用户姓名",
        "is_active": true,
        "is_superuser": false
      }
    ],
    "count": 10
  },
  "message": ""
}
```

**2. 创建用户**
```
POST /api/v1/users/create
Header: auth: <token>
Body: {
  "email": "newuser@example.com",
  "password": "password123",
  "full_name": "新用户",
  "is_active": true,
  "is_superuser": false
}

Response:
{
  "error": 0,
  "body": {
    "id": "uuid",
    "email": "newuser@example.com",
    "full_name": "新用户",
    "is_active": true,
    "is_superuser": false
  },
  "message": "用户创建成功"
}
```

**3. 更新用户信息**
```
POST /api/v1/users/update
Header: auth: <token>
Body: {
  "user_id": "uuid",
  "email": "updated@example.com",
  "full_name": "更新的姓名",
  "is_active": true,
  "is_superuser": false,
  "password": "newpassword123" // 可选
}

Response:
{
  "error": 0,
  "body": {
    "id": "uuid",
    "email": "updated@example.com",
    "full_name": "更新的姓名",
    "is_active": true,
    "is_superuser": false
  },
  "message": "用户信息更新成功"
}
```

**4. 删除用户**
```
POST /api/v1/users/delete
Header: auth: <token>
Body: {
  "user_id": "uuid"
}

Response:
{
  "error": 0,
  "body": {},
  "message": "用户删除成功"
}
```

**5. 重置用户密码**
```
POST /api/v1/users/reset-password
Header: auth: <token>
Body: {
  "user_id": "uuid",
  "new_password": "newpassword123"
}

Response:
{
  "error": 0,
  "body": {},
  "message": "密码重置成功"
}
```

#### 4.2.2 通用接口

**1. 获取当前用户信息**
```
POST /api/v1/users/me
Header: auth: <token>
Body: {}

Response:
{
  "error": 0,
  "body": {
    "id": "uuid",
    "email": "user@example.com",
    "full_name": "用户姓名",
    "is_active": true,
    "is_superuser": false
  },
  "message": ""
}
```

**2. 更新个人信息**
```
POST /api/v1/users/update-me
Header: auth: <token>
Body: {
  "email": "newemail@example.com",
  "full_name": "新姓名"
}

Response:
{
  "error": 0,
  "body": {
    "id": "uuid",
    "email": "newemail@example.com",
    "full_name": "新姓名",
    "is_active": true,
    "is_superuser": false
  },
  "message": "个人信息更新成功"
}
```

**3. 修改密码**
```
POST /api/v1/users/change-password
Header: auth: <token>
Body: {
  "current_password": "oldpassword",
  "new_password": "newpassword123"
}

Response:
{
  "error": 0,
  "body": {},
  "message": "密码修改成功"
}
```

**4. 删除自己的账号**
```
POST /api/v1/users/delete-me
Header: auth: <token>
Body: {}

Response:
{
  "error": 0,
  "body": {},
  "message": "账号删除成功"
}
```

#### 4.2.3 认证接口

**1. 用户登录**
```
POST /api/v1/auth/login
Body: {
  "username": "user@example.com",
  "password": "password123"
}

Response:
{
  "error": 0,
  "body": {
    "access_token": "jwt-token-string",
    "token_type": "bearer",
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "full_name": "用户姓名",
      "is_active": true,
      "is_superuser": false
    }
  },
  "message": "登录成功"
}
```

**2. 验证Token**
```
POST /api/v1/auth/verify-token
Header: auth: <token>
Body: {}

Response:
{
  "error": 0,
  "body": {
    "valid": true,
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "full_name": "用户姓名",
      "is_active": true,
      "is_superuser": false
    }
  },
  "message": ""
}
```

## 5. 前端功能设计

### 5.1 页面结构

```
/app
├── login/                    # 登录页面
│   └── page.tsx
├── dashboard/               # 仪表盘（用户主页）
│   └── page.tsx
├── users/                   # 用户管理（管理员专用）
│   ├── page.tsx            # 用户列表
│   ├── create/             # 创建用户
│   │   └── page.tsx
│   └── [id]/               # 用户详情/编辑
│       └── page.tsx
├── profile/                # 个人资料
│   └── page.tsx
└── settings/               # 设置页面
    └── page.tsx
```

### 5.2 组件设计

#### 5.2.1 用户管理组件（管理员）

**1. UserList 组件**
- 功能：显示用户列表，支持分页、搜索、筛选
- 操作：查看详情、编辑、删除、重置密码
- 权限：仅管理员可访问

**2. UserForm 组件**
- 功能：创建/编辑用户表单
- 字段：邮箱、姓名、密码、角色、状态
- 验证：邮箱格式、密码强度、必填字段

**3. UserDetail 组件**
- 功能：显示用户详细信息
- 操作：编辑信息、重置密码、删除用户

#### 5.2.2 个人资料组件

**1. ProfileForm 组件**
- 功能：编辑个人基本信息
- 字段：姓名、邮箱
- 验证：邮箱唯一性

**2. PasswordForm 组件**
- 功能：修改个人密码
- 字段：当前密码、新密码、确认密码
- 验证：当前密码验证、新密码强度

#### 5.2.3 通用组件

**1. AuthGuard 组件**
- 功能：路由权限保护
- 检查：用户登录状态、角色权限

**2. ApiClient 工具**
- 功能：统一的API调用封装
- 特性：自动token管理、错误处理、响应格式化

### 5.3 状态管理

使用 React Context 或状态管理库管理：

```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

interface UserManagementState {
  users: User[];
  currentUser: User | null;
  loading: boolean;
  error: string | null;
}
```

### 5.4 页面功能详细设计

#### 5.4.1 登录页面 (/login)
- 邮箱/密码登录表单
- 表单验证
- 登录错误提示
- 记住登录状态
- 登录成功后根据角色跳转

#### 5.4.2 用户管理页面 (/users) - 管理员专用
- 用户列表表格（邮箱、姓名、状态、角色、创建时间）
- 搜索框（按邮箱/姓名搜索）
- 筛选器（角色、状态）
- 分页控件
- 批量操作（批量删除、批量启用/禁用）
- 创建用户按钮

#### 5.4.3 创建用户页面 (/users/create) - 管理员专用
- 用户信息表单
- 表单验证
- 创建成功后跳转到用户列表

#### 5.4.4 用户详情页面 (/users/[id]) - 管理员专用
- 用户信息展示
- 编辑用户信息
- 重置密码功能
- 删除用户功能
- 操作日志（可选）

#### 5.4.5 个人资料页面 (/profile)
- 个人信息展示和编辑
- 密码修改表单
- 头像上传（可选）
- 删除账号功能（非管理员）

#### 5.4.6 仪表盘页面 (/)
- 根据用户角色显示不同内容
- 管理员：用户统计、系统概览
- 普通用户：个人数据、功能快捷入口

## 6. 安全考虑

### 6.1 认证安全
- JWT token 管理
- Token 过期处理
- 自动登出机制

### 6.2 权限控制
- 前后端双重权限验证
- API 接口权限中间件
- 页面路由权限保护

### 6.3 数据安全
- 密码加密存储
- 敏感信息脱敏
- SQL 注入防护

## 7. 错误处理

### 7.1 前端错误处理
- 网络请求错误
- 表单验证错误
- 权限错误提示
- 用户友好的错误消息

### 7.2 后端错误处理
- 统一错误响应格式
- 详细的错误日志
- 异常情况处理

## 8. 实施建议

### 8.1 开发优先级
1. 基础认证功能（登录、token验证）
2. 个人资料管理
3. 管理员用户管理功能
4. 高级功能（批量操作、操作日志）

### 8.2 测试策略
- 单元测试：API接口、组件功能
- 集成测试：认证流程、权限控制
- 端到端测试：完整用户操作流程

### 8.3 部署考虑
- 环境配置
- 数据库迁移
- 初始管理员账号创建
- 安全配置检查

## 9. 现有代码分析

### 9.1 后端现状
基于分析，后端已有基础的用户管理功能：

**现有API路由** (`backend/app/api/routes/users.py`):
- `GET /users/` - 获取用户列表（需要适配为POST）
- `POST /users/` - 创建用户（需要适配响应格式）
- `PATCH /users/me` - 更新个人信息
- `GET /users/me` - 获取当前用户信息
- `DELETE /users/me` - 删除自己账号
- `GET /users/{user_id}` - 获取指定用户信息
- `PATCH /users/{user_id}` - 更新用户信息
- `DELETE /users/{user_id}` - 删除用户

**认证路由** (`backend/app/api/routes/login.py`):
- `POST /login/access-token` - 登录获取token
- `POST /login/test-token` - 验证token

### 9.2 前端现状
前端已有基础页面结构：
- 登录页面 (`wechat-sales-assistant/app/login/page.tsx`) - 静态页面，需要集成API
- 仪表盘页面 (`wechat-sales-assistant/app/page.tsx`) - 已有基础布局
- 设置页面 (`wechat-sales-assistant/app/settings/page.tsx`) - 存在但需要查看内容

### 9.3 需要新增的功能

**后端需要新增**:
1. API响应格式适配器 - 将现有响应转换为统一格式
2. 新的用户管理API路由以符合文档规范
3. 改进的错误处理中间件

**前端需要新增**:
1. API客户端工具类
2. 认证状态管理
3. 用户管理页面和组件
4. 个人资料页面

## 10. API适配层设计

为了将现有的FastAPI标准响应适配为文档规范的格式，需要创建适配层：

### 10.1 响应适配器

```python
# backend/app/api/response_adapter.py
from typing import Any, Optional
from fastapi.responses import JSONResponse
from pydantic import BaseModel

class ApiResponse(BaseModel):
    error: int = 0
    body: Any = {}
    message: str = ""

def create_success_response(data: Any = {}, message: str = "") -> JSONResponse:
    """创建成功响应"""
    response = ApiResponse(error=0, body=data, message=message)
    return JSONResponse(content=response.model_dump())

def create_error_response(error_code: int, message: str, data: Any = {}) -> JSONResponse:
    """创建错误响应"""
    response = ApiResponse(error=error_code, body=data, message=message)
    return JSONResponse(content=response.model_dump())

def create_business_error_response(message: str, data: Any = {}) -> JSONResponse:
    """创建业务错误响应"""
    return create_error_response(400, message, data)

def create_auth_error_response(message: str = "需要登录") -> JSONResponse:
    """创建认证错误响应"""
    return create_error_response(401, message)

def create_permission_error_response(message: str = "权限不足") -> JSONResponse:
    """创建权限错误响应"""
    return create_error_response(403, message)

def create_system_error_response(message: str = "系统异常") -> JSONResponse:
    """创建系统错误响应"""
    return create_error_response(500, message)
```

### 10.2 新的用户管理路由

```python
# backend/app/api/routes/user_management.py
from fastapi import APIRouter, Depends, HTTPException
from typing import Any, Dict
from app.api.response_adapter import *
from app.api.deps import CurrentUser, SessionDep, get_current_active_superuser
from app import crud
from app.models import UserCreate, UserUpdate

router = APIRouter(prefix="/api/v1/users", tags=["user-management"])

@router.post("/list")
def list_users(
    request: Dict[str, Any],
    session: SessionDep,
    current_user: CurrentUser = Depends(get_current_active_superuser)
) -> JSONResponse:
    """获取用户列表（管理员专用）"""
    try:
        skip = request.get("skip", 0)
        limit = request.get("limit", 100)
        
        # 调用现有的用户列表逻辑
        count_statement = select(func.count()).select_from(User)
        count = session.exec(count_statement).one()
        
        statement = select(User).offset(skip).limit(limit)
        users = session.exec(statement).all()
        
        data = {
            "data": [user.model_dump() for user in users],
            "count": count
        }
        
        return create_success_response(data)
    except Exception as e:
        return create_system_error_response(str(e))

@router.post("/create")
def create_user_api(
    request: Dict[str, Any],
    session: SessionDep,
    current_user: CurrentUser = Depends(get_current_active_superuser)
) -> JSONResponse:
    """创建用户（管理员专用）"""
    try:
        # 验证输入
        user_create = UserCreate(**request)
        
        # 检查邮箱是否已存在
        existing_user = crud.get_user_by_email(session=session, email=user_create.email)
        if existing_user:
            return create_business_error_response("该邮箱已被使用")
        
        # 创建用户
        user = crud.create_user(session=session, user_create=user_create)
        
        return create_success_response(user.model_dump(), "用户创建成功")
    except Exception as e:
        return create_system_error_response(str(e))

# ... 其他新API路由
```

### 10.3 认证适配器

```python
# backend/app/api/routes/auth_adapter.py
from fastapi import APIRouter, Depends, Form
from fastapi.security import OAuth2PasswordRequestForm
from app.api.response_adapter import *
from app.api.deps import CurrentUser, SessionDep
from app import crud
from app.core import security

router = APIRouter(prefix="/api/v1/auth", tags=["auth"])

@router.post("/login")
def login_api(request: Dict[str, Any], session: SessionDep) -> JSONResponse:
    """用户登录"""
    try:
        username = request.get("username")
        password = request.get("password")
        
        if not username or not password:
            return create_business_error_response("用户名和密码不能为空")
        
        user = crud.authenticate(session=session, email=username, password=password)
        if not user:
            return create_business_error_response("用户名或密码错误")
        elif not user.is_active:
            return create_business_error_response("账户已被禁用")
        
        access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        access_token = security.create_access_token(
            user.id, expires_delta=access_token_expires
        )
        
        data = {
            "access_token": access_token,
            "token_type": "bearer",
            "user": user.model_dump()
        }
        
        return create_success_response(data, "登录成功")
    except Exception as e:
        return create_system_error_response(str(e))

@router.post("/verify-token")
def verify_token_api(current_user: CurrentUser) -> JSONResponse:
    """验证Token"""
    try:
        data = {
            "valid": True,
            "user": current_user.model_dump()
        }
        return create_success_response(data)
    except Exception as e:
        return create_auth_error_response("Token无效")
```

## 11. 前端API客户端设计

### 11.1 API客户端基础类

```typescript
// wechat-sales-assistant/lib/api-client.ts
interface ApiResponse<T = any> {
  error: number;
  body: T;
  message: string;
}

class ApiClient {
  private baseURL: string;
  private token: string | null = null;

  constructor(baseURL: string) {
    this.baseURL = baseURL;
    this.loadToken();
  }

  private loadToken() {
    this.token = localStorage.getItem('auth_token');
  }

  private saveToken(token: string) {
    this.token = token;
    localStorage.setItem('auth_token', token);
  }

  private clearToken() {
    this.token = null;
    localStorage.removeItem('auth_token');
  }

  async request<T = any>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const url = `${this.baseURL}${endpoint}`;
    const headers: Record<string, string> = {
      'Content-Type': 'application/json',
      ...options.headers as Record<string, string>,
    };

    if (this.token) {
      headers.auth = this.token;
    }

    const response = await fetch(url, {
      method: 'POST', // 默认POST方法
      ...options,
      headers,
    });

    const data: ApiResponse<T> = await response.json();

    // 统一错误处理
    if (data.error !== 0) {
      if (data.error === 401) {
        this.clearToken();
        window.location.href = '/login';
        throw new Error('需要重新登录');
      } else if (data.error === 500) {
        throw new Error('系统异常，请稍后重试');
      } else {
        throw new Error(data.message || '操作失败');
      }
    }

    return data.body;
  }

  // 认证相关
  async login(username: string, password: string) {
    const response = await this.request<{
      access_token: string;
      token_type: string;
      user: User;
    }>('/api/v1/auth/login', {
      body: JSON.stringify({ username, password }),
    });

    this.saveToken(response.access_token);
    return response;
  }

  async verifyToken() {
    return this.request<{ valid: boolean; user: User }>('/api/v1/auth/verify-token', {
      body: JSON.stringify({}),
    });
  }

  // 用户管理相关
  async getUserList(skip = 0, limit = 100) {
    return this.request<{ data: User[]; count: number }>('/api/v1/users/list', {
      body: JSON.stringify({ skip, limit }),
    });
  }

  async createUser(userData: CreateUserData) {
    return this.request<User>('/api/v1/users/create', {
      body: JSON.stringify(userData),
    });
  }

  async updateUser(userId: string, userData: UpdateUserData) {
    return this.request<User>('/api/v1/users/update', {
      body: JSON.stringify({ user_id: userId, ...userData }),
    });
  }

  async deleteUser(userId: string) {
    return this.request('/api/v1/users/delete', {
      body: JSON.stringify({ user_id: userId }),
    });
  }

  // 个人信息相关
  async getCurrentUser() {
    return this.request<User>('/api/v1/users/me', {
      body: JSON.stringify({}),
    });
  }

  async updateProfile(profileData: UpdateProfileData) {
    return this.request<User>('/api/v1/users/update-me', {
      body: JSON.stringify(profileData),
    });
  }

  async changePassword(currentPassword: string, newPassword: string) {
    return this.request('/api/v1/users/change-password', {
      body: JSON.stringify({
        current_password: currentPassword,
        new_password: newPassword,
      }),
    });
  }
}

export const apiClient = new ApiClient(process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000');
```

### 11.2 类型定义

```typescript
// wechat-sales-assistant/types/user.ts
export interface User {
  id: string;
  email: string;
  full_name: string | null;
  is_active: boolean;
  is_superuser: boolean;
}

export interface CreateUserData {
  email: string;
  password: string;
  full_name?: string;
  is_active?: boolean;
  is_superuser?: boolean;
}

export interface UpdateUserData {
  email?: string;
  full_name?: string;
  is_active?: boolean;
  is_superuser?: boolean;
  password?: string;
}

export interface UpdateProfileData {
  email?: string;
  full_name?: string;
}
```

## 12. 实施步骤

### 12.1 第一阶段：基础认证
1. 创建API适配层
2. 实现前端API客户端
3. 完善登录页面功能
4. 实现认证状态管理

### 12.2 第二阶段：个人资料管理
1. 创建个人资料页面
2. 实现个人信息编辑功能
3. 实现密码修改功能

### 12.3 第三阶段：用户管理
1. 创建用户管理页面（管理员）
2. 实现用户列表、创建、编辑、删除功能
3. 实现权限控制

### 12.4 第四阶段：优化和测试
1. 完善错误处理
2. 添加加载状态和用户反馈
3. 编写测试用例
4. 性能优化

这个文档为用户管理模块提供了完整的设计指南，包括了现有代码的分析和新功能的设计。通过API适配层，可以在不大幅修改现有代码的基础上，实现符合新规范的API接口。 